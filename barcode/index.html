<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>バーコード連続スキャン</title>
  <!-- QuaggaJS CDN -->
  <script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>
  <style>
    #interactive {
      width: 100%;
      position: relative;
    }
    #scanner-container, #scanned-items {
      margin-top: 16px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h1>バーコード連続スキャン</h1>

  <!-- 実施日を選択 -->
  <div>
    <label for="dateInput">実施日:</label>
    <input type="date" id="dateInput" />
  </div>

  <!-- スキャナ画面 -->
  <div id="scanner-container">
    <button id="startScanBtn">スキャン開始</button>
    <button id="stopScanBtn" class="hidden">スキャン停止</button>
    <div id="interactive" class="hidden"></div>
  </div>

  <!-- スキャン結果リスト -->
  <div id="scanned-items">
    <h2>スキャン結果</h2>
    <ul id="scannedList"></ul>
  </div>

  <!-- 送信(確定)ボタン -->
  <button id="finishBtn" class="hidden">終了 (確定)</button>

  <script>
    // スキャンした結果を保持する配列
    let scannedList = [];
    // 現在スキャン中かどうか
    let isScanning = false;
    // 選択日付
    let selectedDate = "";

    /**
     * QuaggaJS 初期化
     */
    function initQuagga() {
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector('#interactive'),
          constraints: {
            facingMode: "environment", // 背面カメラ推奨
            // width: 640, height: 480, など指定も可能
          }
        },
        decoder: {
          readers: [
            "ean_reader",      // JANコードに対応 (EAN-13)
            "code_128_reader",
            "code_39_reader"
          ]
        },
        locate: true   // バーコードを自動検出
      }, function(err) {
        if (err) {
          console.error(err);
          alert("QuaggaJSの初期化に失敗しました: " + err);
          return;
        }
        Quagga.start();
        console.log("QuaggaJS initialized and started");
      });

      // バーコード検出時
      Quagga.onDetected(onBarcodeDetected);
    }

    /**
     * バーコードが検出されたとき
     */
    function onBarcodeDetected(result) {
      const code = result.codeResult.code;
      console.log("Detected:", code);

      // 連続スキャンで連続検出しすぎないよう、一時停止
      Quagga.pause();

      // スキャン結果を配列に追加
      scannedList.push({
        date: selectedDate,
        barcode: code 
      });

      // 画面に追加
      updateScannedList();

      // ちょっと待って再開
      setTimeout(() => {
        if (isScanning) {
          Quagga.start();
        }
      }, 700);
    }

    /**
     * スキャン結果リストを画面に反映
     */
    function updateScannedList() {
      const ul = document.getElementById("scannedList");
      ul.innerHTML = ""; // 一旦クリア

      scannedList.forEach(item => {
        const li = document.createElement("li");
        li.textContent = `日付: ${item.date}, バーコード: ${item.barcode}`;
        ul.appendChild(li);
      });
    }

    /**
     * スキャン開始ボタン
     */
    function startScanner() {
      // 日付が入力されているかチェック
      selectedDate = document.getElementById("dateInput").value;
      if (!selectedDate) {
        alert("実施日を入れてください");
        return;
      }

      // UI切替
      isScanning = true;
      document.getElementById("interactive").classList.remove("hidden");
      document.getElementById("startScanBtn").classList.add("hidden");
      document.getElementById("stopScanBtn").classList.remove("hidden");
      document.getElementById("finishBtn").classList.remove("hidden");

      // Quagga初期化＆開始
      initQuagga();
    }

    /**
     * スキャン停止ボタン
     */
    function stopScanner() {
      isScanning = false;
      Quagga.stop();
      document.getElementById("interactive").classList.add("hidden");
      document.getElementById("startScanBtn").classList.remove("hidden");
      document.getElementById("stopScanBtn").classList.add("hidden");
    }

    /**
     * 送信(確定)ボタン
     */
    function finishAndSend() {
      if (!scannedList.length) {
        alert("スキャン結果がありません。");
        return;
      }

      // 送信前に停止
      stopScanner();

      const ok = confirm("スキャン結果を送信しますか？");
      if (!ok) return;

      // 送信先GASのURL (あとで正しいものに置き換えてください)
      const gasUrl = "https://script.google.com/macros/s/AKfycbwWoWxXxSsHi_wbIzVdJiijN8Ki1YjcIiK4j0zQoEISaKwyuHLIjIjYhw6NtSVyAxla/exec";

      // JSON化
      const postData = JSON.stringify(scannedList);

      fetch(gasUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: postData
      })
      .then(response => response.text())
      .then(text => {
        console.log("Response from GAS:", text);
        alert("送信完了: " + text);

        // 送信後はローカル配列をクリア
        scannedList = [];
        updateScannedList();

        // ボタン非表示 (必要な場合)
        document.getElementById("finishBtn").classList.add("hidden");
      })
      .catch(err => {
        console.error("送信失敗:", err);
        alert("送信エラー: " + err);
      });
    }

    // イベントリスナー
    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("startScanBtn").addEventListener("click", startScanner);
      document.getElementById("stopScanBtn").addEventListener("click", stopScanner);
      document.getElementById("finishBtn").addEventListener("click", finishAndSend);
    });
  </script>
</body>
</html>